

<%= form_with model: [current_account, @inventory_unit], local: true, multipart: true do |form| %>
  <% if @inventory_unit.errors.any? %>
    <div class="notification is-danger">
      <ul>
        <% @inventory_unit.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <%= render "product_option_selector", products: @products, selected_product: @selected_product %>

  <div class="field">
    <%= form.label :serial_number, "S/N or Unique ID", class: "label" %>
    <div class="control">
      <%= form.text_field :serial_number, class: "input" %>
    </div>
  </div>

  <div class="field">
    <%= form.label :status, class: "label" %>
    <div class="control">
      <div class="select">
        <%= form.select :status, InventoryUnit.statuses.keys.map { |s| [s.humanize, s] }, {} %>
      </div>
    </div>
  </div>

  <div class="field">
    <%= form.label :location_id, "Storage Location", class: "label" %>
    <div class="control">
      <div class="select">
        <%= form.collection_select :location_id, current_account.locations, :id, :name, { prompt: "Select a location (optional)" }, {} %>
      </div>
    </div>
    <p class="help">Choose where this item is physically stored</p>
  </div>

  <div class="field" data-controller="file-input">
    <%= form.label :images, class: "label" %>
    <div class="control">
      <div class="file has-name is-fullwidth">
        <label class="file-label">
          <%= form.file_field :images, multiple: true, accept: "image/*", class: "file-input", data: { action: "change->file-input#updateFileName", "file-input-target": "input" } %>
          <span class="file-cta">
            <span class="file-icon">
              <i class="fas fa-upload"></i>
            </span>
            <span class="file-label">
              <%= @inventory_unit.persisted? ? "Add more images…" : "Choose images…" %>
            </span>
          </span>
          <span class="file-name" data-file-input-target="fileName">
            No files selected
          </span>
        </label>
      </div>
    </div>
    <p class="help">
      <%= @inventory_unit.persisted? ? "Select additional images to add to existing ones." : "You can select multiple images." %> 
      Supported formats: JPG, PNG, GIF
    </p>
    
  </div>

  <% if @inventory_unit.persisted? && @inventory_unit.images.any? %>
    <div class="field">
      <label class="label">Current Images</label>
      <div class="columns is-multiline">
        <% @inventory_unit.images.each do |image| %>
          <div class="column is-3">
            <div class="card">
              <div class="card-image">
                <figure class="image is-square">
                  <%= image_tag image, class: "is-fullwidth", style: "object-fit: cover;" %>
                </figure>
                <%= link_to delete_image_attachment_account_inventory_unit_path(current_account, @inventory_unit, signed_id: image.signed_id),
                    data: { 
                      turbo_method: :delete,
                      turbo_confirm: 'Remove this image?' 
                    },
                    class: "delete is-large",
                    style: "position: absolute; top: 0.5rem; right: 0.5rem;" do %>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <div class="field">
    <div class="control">
      <%= form.submit (form.object.new_record? ? "Create Inventory Unit" : "Update Inventory Unit"), class: "button is-primary" %>
    </div>
  </div>
<% end %> 